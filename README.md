### Displacement to strain calculation

This program generates strain maps from displacement (motion) maps, with the goal of processing the ML model output to show strain levels across material images rather than motion. The input maps are generated by the motion model as 2D arrays of <x,y> motion at each point in the material image, and the program uses VSG strain calculation to create a 2D array of <XX,YY,XY> strain values. 

### How strain works

Strain is a measure of how much a material has been stretched. Specifically, it is the derivative of the displacement. When force is applied to a material and it is deformed, points on the material will move in reaction to that force. Compared to raw motion, strain is a better measure of deformation because it accounts for how displacement compounds over distance as all parts of the material stretch at once.

### Methodology

To calculate strain, a VSG (virtual strain gauge) is used. A sliding window is applied to the displacment map, and a linear polynomial fit is applied to all displacement in the window. The coefficients of this polynomial are then used to calculate green lagrange strain with the following equations:

```
strain_xx = 0.5*(2.0*dudx + dudx*dudx + dvdx*dvdx);
strain_yy = 0.5*(2.0*dvdy + dudy*dudy + dvdy*dvdy);
strain_xy = 0.5*(dudy + dvdx + dudx*dudy + dvdx*dvdy);
```

In addition, a gaussian filter may optionally be applied before and after strain calculation to reduce noise and emphasize results.

### Results

![Displacement and strain map comparison](https://i.ibb.co/bg7qw2By/Figure-1-2.png)

### How to run:

1. Download strain_calc.exe from releases (if on windows)

2. Run using command line:

```
./strain_calc.exe <disp file/folder path> <subset size> [-npy/jpg] [-o <output_dir>] [-b]
```

- Program will output strain in a txt file by default, or you can specify -npy or -jpg to output in other formats.
- Specify -b to apply a gaussian blur to input and output

> Note: displacement input files should be npy files with double precision and in the shape (rows, cols, 2).

### Building (Must do if on linux/Mac)

1. Download source files
2. Ensure all dependencies are downloaded (see below)
3. Run the following commands in the source folder depending on OS:

#### Windows

```
mkdir build
cd build
cmake .. -G "Visual Studio 17 2022"
cmake --build . --config Release
```

#### Linux

```
mkdir build
cd build
cmake ..
make
```

### Dependencies

CMake is required for building from source. It can be downloaded from [Cmake website](https://cmake.org/download/) for windows 
or through the command line for linux/Mac.

Visual Studio is required if building from source on windows.

Eigen is used for matrix operations. It can be downloaded from the [Eigen website](http://eigen.tuxfamily.org/index.php).
Put the Eigen folder in the dependencies folder at `dependencies/Eigen/`.

OpenCV is required for strain pre/post processing. It can be downloaded from [OpenCV website](https://opencv.org/releases/).
**If on windows, after downloading, you must:**

1. Add the path to opencv/build on your computer to your PATH environment variable

2. In opencv/build/x64/vc16/bin, copy all dll and pdb files to the same folder as your strain_calc.exe

## Credits

- [Cmake](https://cmake.org/) for building project
- [Eigen](http://eigen.tuxfamily.org/index.php) for matrix operations
- [cnpy](https://github.com/rogersce/cnpy) for reading and writing numpy files
- [stb](https://github.com/nothings/stb/tree/master) for exporting images
- [OpenCV](https://github.com/opencv/opencv/tree/4.11.0) for pre/post processing
